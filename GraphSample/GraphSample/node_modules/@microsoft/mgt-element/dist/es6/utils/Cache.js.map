{"version":3,"file":"Cache.js","sourceRoot":"src/","sources":["utils/Cache.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * -------------------------------------------------------------------------------------------\n * Copyright (c) Microsoft Corporation.  All Rights Reserved.  Licensed under the MIT License.\n * See License in the project root for license information.\n * -------------------------------------------------------------------------------------------\n */\n\nimport { openDB } from 'idb';\nimport { Providers } from '../providers/Providers';\nimport { ProviderState } from '../providers/IProvider';\n\n/**\n * Holds the cache options for cache store\n *\n * @export\n * @interface CacheConfig\n */\nexport interface CacheConfig {\n  /**\n   * Default global invalidation period\n   *\n   * @type {number}\n   * @memberof CacheConfig\n   */\n  defaultInvalidationPeriod: number;\n  /**\n   * Controls whether the cache is enabled globally\n   *\n   * @type {boolean}\n   * @memberof CacheConfig\n   */\n  isEnabled: boolean;\n  /**\n   * Cache options for groups store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  groups: CacheOptions;\n  /**\n   * Cache options for people store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  people: CacheOptions;\n  /**\n   * Cache options for photos store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  photos: CacheOptions;\n  /**\n   * Cache options for presence store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n\n  presence: CacheOptions;\n  /**\n   * Cache options for users store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  users: CacheOptions;\n\n  /**\n   * Cache options for a generic response store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  response: CacheOptions;\n\n  /**\n   * Cache options for files store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  files: CacheOptions;\n  /**\n   * Cache options for fileLists store\n   *\n   * @type {CacheOptions}\n   * @memberof CacheConfig\n   */\n  fileLists: CacheOptions;\n}\n\n/**\n * Options for each store\n *\n * @export\n * @interface CacheOptions\n */\nexport interface CacheOptions {\n  /**\n   * Defines the time (in ms) for objects in the store to expire\n   *\n   * @type {number}\n   * @memberof CacheOptions\n   */\n  invalidationPeriod: number;\n  /**\n   * Whether the store is enabled or not\n   *\n   * @type {boolean}\n   * @memberof CacheOptions\n   */\n  isEnabled: boolean;\n}\n\n/**\n * class in charge of managing all the caches and their stores\n *\n * @export\n * @class CacheService\n */\n// tslint:disable-next-line: max-classes-per-file\nexport class CacheService {\n  /**\n   *  Looks for existing cache, otherwise creates a new one\n   *\n   * @static\n   * @template T\n   * @param {CacheSchema} schema\n   * @param {string} storeName\n   * @returns {CacheStore<T>}\n   * @memberof CacheService\n   */\n  public static getCache<T extends CacheItem>(schema: CacheSchema, storeName: string): CacheStore<T> {\n    const key = `${schema.name}/${storeName}`;\n\n    if (!this.isInitialized) {\n      this.init();\n    }\n\n    if (!this.cacheStore.has(storeName)) {\n      this.cacheStore.set(key, new CacheStore<T>(schema, storeName));\n    }\n    return this.cacheStore.get(key) as CacheStore<T>;\n  }\n\n  /**\n   * Clears all the stores within the cache\n   */\n  public static clearCaches() {\n    this.cacheStore.forEach(x => indexedDB.deleteDatabase(x.getDBName()));\n  }\n\n  private static cacheStore: Map<string, CacheStore<CacheItem>> = new Map();\n  private static isInitialized: boolean = false;\n\n  private static cacheConfig: CacheConfig = {\n    defaultInvalidationPeriod: 3600000,\n    groups: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    isEnabled: true,\n    people: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    photos: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    presence: {\n      invalidationPeriod: 300000,\n      isEnabled: true\n    },\n    users: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    response: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    files: {\n      invalidationPeriod: null,\n      isEnabled: true\n    },\n    fileLists: {\n      invalidationPeriod: null,\n      isEnabled: true\n    }\n  };\n\n  /**\n   * returns the cacheconfig object\n   *\n   * @readonly\n   * @static\n   * @type {CacheConfig}\n   * @memberof CacheService\n   */\n  public static get config(): CacheConfig {\n    return this.cacheConfig;\n  }\n\n  /**\n   * Checks for current sign in state and see if it has changed from signed-in to signed out\n   *\n   *\n   * @private\n   * @static\n   * @memberof CacheService\n   */\n  private static init() {\n    let previousState: ProviderState;\n    if (Providers.globalProvider) {\n      previousState = Providers.globalProvider.state;\n    }\n\n    Providers.onProviderUpdated(() => {\n      if (previousState === ProviderState.SignedIn && Providers.globalProvider.state === ProviderState.SignedOut) {\n        this.clearCaches();\n      }\n      previousState = Providers.globalProvider.state;\n    });\n    this.isInitialized = true;\n  }\n}\n\n/**\n * Represents organization for a cache\n *\n * @export\n * @interface CacheSchema\n */\nexport interface CacheSchema {\n  /**\n   * version number of cache, useful for upgrading\n   *\n   * @type {number}\n   * @memberof CacheSchema\n   */\n  version: number;\n  /**\n   * name of the cache\n   *\n   * @type {string}\n   * @memberof CacheSchema\n   */\n  name: string;\n  /**\n   * list of stores in the cache\n   *\n   * @type {{ [name: string]: CacheSchemaStore }}\n   * @memberof CacheSchema\n   */\n  stores: { [name: string]: string };\n}\n\n/**\n * item that is stored in cache\n *\n * @export\n * @interface CacheItem\n */\nexport interface CacheItem {\n  /**\n   * date and time that item was retrieved from api/stored in cache\n   *\n   * @type {number}\n   * @memberof CacheItem\n   */\n  timeCached?: number;\n}\n\n/**\n * Represents a store in the cache\n *\n * @class CacheStore\n * @template T\n */\n// tslint:disable-next-line: max-classes-per-file\nexport class CacheStore<T extends CacheItem> {\n  private schema: CacheSchema;\n  private store: string;\n\n  public constructor(schema: CacheSchema, store: string) {\n    if (!(store in schema.stores)) {\n      throw Error('\"store\" must be defined in the \"schema\"');\n    }\n\n    this.schema = schema;\n    this.store = store;\n  }\n\n  /**\n   * gets value from cache for the given key\n   *\n   * @param {string} key\n   * @returns {Promise<T>}\n   * @memberof Cache\n   */\n  public async getValue(key: string): Promise<T> {\n    if (!window.indexedDB) {\n      return null;\n    }\n    try {\n      return (await this.getDb()).get(this.store, key);\n    } catch (e) {\n      return null;\n    }\n  }\n\n  /**\n   * inserts value into cache for the given key\n   *\n   * @param {string} key\n   * @param {T} item\n   * @returns\n   * @memberof Cache\n   */\n  public async putValue(key: string, item: T) {\n    if (!window.indexedDB) {\n      return;\n    }\n    try {\n      await (await this.getDb()).put(this.store, { ...item, timeCached: Date.now() }, key);\n    } catch (e) {\n      return;\n    }\n  }\n\n  /**\n   * Clears the store of all stored values\n   *\n   * @returns\n   * @memberof Cache\n   */\n  public async clearStore() {\n    if (!window.indexedDB) {\n      return;\n    }\n    try {\n      (await this.getDb()).clear(this.store);\n    } catch (e) {\n      return;\n    }\n  }\n\n  /**\n   * Returns the name of the parent DB that the cache store belongs to\n   */\n  public getDBName() {\n    return `mgt-${this.schema.name}`;\n  }\n\n  private getDb() {\n    return openDB(this.getDBName(), this.schema.version, {\n      upgrade: (db, oldVersion, newVersion, transaction) => {\n        for (const storeName in this.schema.stores) {\n          if (this.schema.stores.hasOwnProperty(storeName)) {\n            db.objectStoreNames.contains(storeName) || db.createObjectStore(storeName);\n          }\n        }\n      }\n    });\n  }\n}\n"]}