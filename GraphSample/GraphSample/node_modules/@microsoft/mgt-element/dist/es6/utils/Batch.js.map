{"version":3,"file":"Batch.js","sourceRoot":"src/","sources":["utils/Batch.ts"],"names":[],"mappings":"AAAA;;;;;GAKG;;;;;;;;;;AAEH,OAAO,EAAE,aAAa,EAAU,MAAM,WAAW,CAAC;AAClD,OAAO,EAAE,mBAAmB,EAAqB,MAAM,mCAAmC,CAAC;AAC3F,OAAO,EAAE,KAAK,EAAE,MAAM,UAAU,CAAC;AACjC,OAAO,EAAE,UAAU,EAAE,MAAM,gBAAgB,CAAC;AAG5C;;;;GAIG;AACH,MAAM,OAAO,YAAY;IA2CvB,YAAY,KAAK,EAAE,EAAE,EAAE,QAAgB,EAAE,MAAc;QACrD,IAAI,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE;YAC9B,QAAQ,GAAG,GAAG,GAAG,QAAQ,CAAC;SAC3B;QACD,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,EAAE,GAAG,EAAE,CAAC;IACf,CAAC;CACF;AAED;;;;;GAKG;AACH,iDAAiD;AACjD,MAAM,OAAO,KAAK;IAchB,YAAY,KAAa;QACvB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,WAAW,GAAG,EAAE,CAAC;QACtB,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;QACxB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,SAAS,GAAG,CAAC,CAAC;QACnB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;IACtB,CAAC;IAED;;;;;OAKG;IACH,IAAW,WAAW;QACpB,OAAO,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC;IACvC,CAAC;IAED;;;;;;;OAOG;IACI,GAAG,CAAC,EAAU,EAAE,QAAgB,EAAE,MAAiB,EAAE,OAAsC;QAChG,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC;QAC/B,MAAM,OAAO,GAAG,IAAI,YAAY,CAAC,KAAK,EAAE,EAAE,EAAE,QAAQ,EAAE,KAAK,CAAC,CAAC;QAC7D,OAAO,CAAC,OAAO,GAAG,OAAO,CAAC;QAC1B,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC/B,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/B,IAAI,MAAM,EAAE;YACV,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;SAC1C;IACH,CAAC;IAED;;;;;;OAMG;IACU,WAAW;;YACtB,MAAM,SAAS,GAA+B,IAAI,GAAG,EAAE,CAAC;YAExD,IAAI,IAAI,CAAC,UAAU,EAAE;gBACnB,MAAM,KAAK,CAAC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,CAAC;gBACpC,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;aACrB;YAED,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;gBACrB,OAAO,SAAS,CAAC;aAClB;YAED,sCAAsC;YACtC,MAAM,SAAS,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YAEnD,MAAM,mBAAmB,GAAG,IAAI,mBAAmB,EAAE,CAAC;YAEtD,KAAK,MAAM,OAAO,IAAI,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,EAAE;gBAC7D,mBAAmB,CAAC,UAAU,CAAC;oBAC7B,EAAE,EAAE,OAAO,CAAC,KAAK,CAAC,QAAQ,EAAE;oBAC5B,OAAO,EAAE,IAAI,OAAO,CAAC,KAAK,CAAC,OAAO,GAAG,OAAO,CAAC,QAAQ,EAAE;wBACrD,MAAM,EAAE,OAAO,CAAC,MAAM;wBACtB,OAAO,EAAE,OAAO,CAAC,OAAO;qBACzB,CAAC;iBACH,CAAC,CAAC;aACJ;YAED,MAAM,iBAAiB,GAAwB,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,UAAU,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;YACpG,MAAM,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;YAEnF,MAAM,gBAAgB,GAAG,MAAM,mBAAmB,CAAC,UAAU,EAAE,CAAC;YAChE,MAAM,aAAa,GAAG,MAAM,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAEhE,KAAK,MAAM,CAAC,IAAI,aAAa,CAAC,SAAS,EAAE;gBACvC,MAAM,QAAQ,GAAG,IAAI,aAAa,EAAE,CAAC;gBACrC,MAAM,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;gBAEvC,QAAQ,CAAC,EAAE,GAAG,OAAO,CAAC,EAAE,CAAC;gBACzB,QAAQ,CAAC,KAAK,GAAG,OAAO,CAAC,KAAK,CAAC;gBAC/B,QAAQ,CAAC,OAAO,GAAG,CAAC,CAAC,OAAO,CAAC;gBAE7B,IAAI,CAAC,CAAC,MAAM,KAAK,GAAG,EAAE;oBACpB,IAAI,CAAC,CAAC,MAAM,KAAK,GAAG,EAAE;wBACpB,6BAA6B;wBAC7B,oDAAoD;wBACpD,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;wBACjC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC,CAAC,OAAO,CAAC,aAAa,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;qBAC1F;oBACD,SAAS;iBACV;qBAAM,IAAI,CAAC,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE;oBAC3D,QAAQ,CAAC,OAAO,GAAG,yBAAyB,GAAG,CAAC,CAAC,IAAI,CAAC;iBACvD;qBAAM,IAAI,CAAC,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAE;oBAC5D,QAAQ,CAAC,OAAO,GAAG,0BAA0B,GAAG,CAAC,CAAC,IAAI,CAAC;iBACxD;qBAAM,IAAI,CAAC,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE;oBAC1D,QAAQ,CAAC,OAAO,GAAG,wBAAwB,GAAG,CAAC,CAAC,IAAI,CAAC;iBACtD;qBAAM;oBACL,QAAQ,CAAC,OAAO,GAAG,CAAC,CAAC,IAAI,CAAC;iBAC3B;gBAED,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;aACrC;YAED,OAAO,SAAS,CAAC;QACnB,CAAC;KAAA;IAED;;;;;;OAMG;IACU,UAAU;;YACrB,MAAM,SAAS,GAA+B,IAAI,GAAG,EAAE,CAAC;YAExD,OAAO,IAAI,CAAC,WAAW,EAAE;gBACvB,MAAM,CAAC,GAAG,MAAM,IAAI,CAAC,WAAW,EAAE,CAAC;gBACnC,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,CAAC,EAAE;oBAC5B,SAAS,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;iBAC3B;aACF;YAED,OAAO,SAAS,CAAC;QACnB,CAAC;KAAA;;AA7ID,uEAAuE;AACvE,uFAAuF;AACxE,aAAO,GAAG,6BAA6B,CAAC","sourcesContent":["/**\n * -------------------------------------------------------------------------------------------\n * Copyright (c) Microsoft Corporation.  All Rights Reserved.  Licensed under the MIT License.\n * See License in the project root for license information.\n * -------------------------------------------------------------------------------------------\n */\n\nimport { BatchResponse, IBatch } from '../IBatch';\nimport { BatchRequestContent, MiddlewareOptions } from '@microsoft/microsoft-graph-client';\nimport { delay } from '../utils';\nimport { prepScopes } from './GraphHelpers';\nimport { IGraph } from '../IGraph';\n\n/**\n * Represents a request to be executed in a batch\n *\n * @class BatchRequest\n */\nexport class BatchRequest {\n  /**\n   * url used in request\n   *\n   * @type {string}\n   * @memberof BatchRequest\n   */\n  public resource: string;\n\n  /**\n   * method passed to be requested\n   *\n   * @type {string}\n   * @memberof BatchRequest\n   */\n  public method: string;\n\n  /**\n   * The index of the requests as it was added to the queue\n   * Use this value if you need to sort the responses\n   * in the order they were added\n   *\n   * @type {number}\n   * @memberof BatchRequest\n   */\n  public index: number;\n\n  /**\n   * The headers of the request\n   *\n   * @type {{[headerName: string]: string}}\n   * @memberof BatchRequest\n   */\n  public headers: { [header: string]: string };\n\n  /**\n   * The id of the requests\n   *\n   * @type {string}\n   * @memberof BatchRequest\n   */\n  public id: string;\n\n  constructor(index, id, resource: string, method: string) {\n    if (resource.charAt(0) !== '/') {\n      resource = '/' + resource;\n    }\n    this.resource = resource;\n    this.method = method;\n    this.index = index;\n    this.id = id;\n  }\n}\n\n/**\n * Method to reduce repetitive requests to the Graph\n *\n * @export\n * @class Batch\n */\n// tslint:disable-next-line: max-classes-per-file\nexport class Batch implements IBatch {\n  // this doesn't really mater what it is as long as it's a root base url\n  // otherwise a Request assumes the current path and that could change the relative path\n  private static baseUrl = 'https://graph.microsoft.com';\n\n  private allRequests: BatchRequest[];\n  private requestsQueue: number[];\n  private scopes: string[];\n  private retryAfter: number;\n\n  private graph: IGraph;\n\n  private nextIndex: number;\n\n  constructor(graph: IGraph) {\n    this.graph = graph;\n    this.allRequests = [];\n    this.requestsQueue = [];\n    this.scopes = [];\n    this.nextIndex = 0;\n    this.retryAfter = 0;\n  }\n\n  /**\n   * Get whether there are requests that have not been executed\n   *\n   * @readonly\n   * @memberof Batch\n   */\n  public get hasRequests() {\n    return this.requestsQueue.length > 0;\n  }\n\n  /**\n   * sets new request and scopes\n   *\n   * @param {string} id\n   * @param {string} resource\n   * @param {string[]} [scopes]\n   * @memberof Batch\n   */\n  public get(id: string, resource: string, scopes?: string[], headers?: { [header: string]: string }) {\n    const index = this.nextIndex++;\n    const request = new BatchRequest(index, id, resource, 'GET');\n    request.headers = headers;\n    this.allRequests.push(request);\n    this.requestsQueue.push(index);\n    if (scopes) {\n      this.scopes = this.scopes.concat(scopes);\n    }\n  }\n\n  /**\n   * Execute the next set of requests.\n   * This will execute up to 20 requests at a time\n   *\n   * @returns {Promise<Map<string, BatchResponse>>}\n   * @memberof Batch\n   */\n  public async executeNext(): Promise<Map<string, BatchResponse>> {\n    const responses: Map<string, BatchResponse> = new Map();\n\n    if (this.retryAfter) {\n      await delay(this.retryAfter * 1000);\n      this.retryAfter = 0;\n    }\n\n    if (!this.hasRequests) {\n      return responses;\n    }\n\n    // batch can support up to 20 requests\n    const nextBatch = this.requestsQueue.splice(0, 20);\n\n    const batchRequestContent = new BatchRequestContent();\n\n    for (const request of nextBatch.map(i => this.allRequests[i])) {\n      batchRequestContent.addRequest({\n        id: request.index.toString(),\n        request: new Request(Batch.baseUrl + request.resource, {\n          method: request.method,\n          headers: request.headers\n        })\n      });\n    }\n\n    const middlewareOptions: MiddlewareOptions[] = this.scopes.length ? prepScopes(...this.scopes) : [];\n    const batchRequest = this.graph.api('$batch').middlewareOptions(middlewareOptions);\n\n    const batchRequestBody = await batchRequestContent.getContent();\n    const batchResponse = await batchRequest.post(batchRequestBody);\n\n    for (const r of batchResponse.responses) {\n      const response = new BatchResponse();\n      const request = this.allRequests[r.id];\n\n      response.id = request.id;\n      response.index = request.index;\n      response.headers = r.headers;\n\n      if (r.status !== 200) {\n        if (r.status === 429) {\n          // this request was throttled\n          // add request back to queue and set retry wait time\n          this.requestsQueue.unshift(r.id);\n          this.retryAfter = Math.max(this.retryAfter, parseInt(r.headers['Retry-After'], 10) || 1);\n        }\n        continue;\n      } else if (r.headers['Content-Type'].includes('image/jpeg')) {\n        response.content = 'data:image/jpeg;base64,' + r.body;\n      } else if (r.headers['Content-Type'].includes('image/pjpeg')) {\n        response.content = 'data:image/pjpeg;base64,' + r.body;\n      } else if (r.headers['Content-Type'].includes('image/png')) {\n        response.content = 'data:image/png;base64,' + r.body;\n      } else {\n        response.content = r.body;\n      }\n\n      responses.set(request.id, response);\n    }\n\n    return responses;\n  }\n\n  /**\n   * Execute all requests, up to 20 at a time until\n   * all requests have been executed\n   *\n   * @returns {Promise<Map<string, BatchResponse>>}\n   * @memberof Batch\n   */\n  public async executeAll(): Promise<Map<string, BatchResponse>> {\n    const responses: Map<string, BatchResponse> = new Map();\n\n    while (this.hasRequests) {\n      const r = await this.executeNext();\n      for (const [key, value] of r) {\n        responses.set(key, value);\n      }\n    }\n\n    return responses;\n  }\n}\n"]}