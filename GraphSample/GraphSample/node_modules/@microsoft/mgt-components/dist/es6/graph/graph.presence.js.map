{"version":3,"file":"graph.presence.js","sourceRoot":"src/","sources":["graph/graph.presence.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * -------------------------------------------------------------------------------------------\n * Copyright (c) Microsoft Corporation.  All Rights Reserved.  Licensed under the MIT License.\n * See License in the project root for license information.\n * -------------------------------------------------------------------------------------------\n */\n\nimport { IGraph, prepScopes, BetaGraph, CacheItem, CacheService, CacheStore } from '@microsoft/mgt-element';\nimport { Presence } from '@microsoft/microsoft-graph-types';\nimport { schemas } from './cacheStores';\nimport { IDynamicPerson } from './types';\n\n/**\n * Object to be stored in cache representing individual people\n */\ninterface CachePresence extends CacheItem {\n  /**\n   * json representing a person stored as string\n   */\n  presence?: string;\n}\n\n/**\n * Defines the expiration time\n */\nconst getPresenceInvalidationTime = (): number =>\n  CacheService.config.presence.invalidationPeriod || CacheService.config.defaultInvalidationPeriod;\n\n/**\n * Whether the groups store is enabled\n */\nconst getIsPresenceCacheEnabled = (): boolean =>\n  CacheService.config.presence.isEnabled && CacheService.config.isEnabled;\n\n/**\n * async promise, allows developer to get user presence\n *\n * @returns {Promise<Presence>}\n * @param {IGraph} graph\n * @param {string} userId - id for the user or null for current signed in user\n * @memberof BetaGraph\n */\nexport async function getUserPresence(graph: IGraph, userId?: string): Promise<Presence> {\n  let cache: CacheStore<CachePresence>;\n\n  if (getIsPresenceCacheEnabled()) {\n    cache = CacheService.getCache(schemas.presence, schemas.presence.stores.presence);\n    const presence = await cache.getValue(userId || 'me');\n    if (presence && getPresenceInvalidationTime() > Date.now() - presence.timeCached) {\n      return JSON.parse(presence.presence);\n    }\n  }\n\n  const scopes = userId ? ['presence.read.all'] : ['presence.read'];\n  const resource = userId ? `/users/${userId}/presence` : '/me/presence';\n\n  const result = await graph\n    .api(resource)\n    .middlewareOptions(prepScopes(...scopes))\n    .get();\n  if (getIsPresenceCacheEnabled()) {\n    cache.putValue(userId || 'me', { presence: JSON.stringify(result) });\n  }\n\n  return result;\n}\n\n/**\n * async promise, allows developer to get person presense by providing array of IDynamicPerson\n *\n * @returns {}\n * @memberof BetaGraph\n */\nexport async function getUsersPresenceByPeople(graph: IGraph, people?: IDynamicPerson[]) {\n  if (!people || people.length === 0) {\n    return {};\n  }\n\n  const peoplePresence = {};\n  const peoplePresenceToQuery: string[] = [];\n  const scopes = ['presence.read.all'];\n  let cache: CacheStore<CachePresence>;\n\n  if (getIsPresenceCacheEnabled()) {\n    cache = CacheService.getCache(schemas.presence, schemas.presence.stores.presence);\n  }\n\n  for (const person of people) {\n    if (person?.id) {\n      const id = person.id;\n      peoplePresence[id] = null;\n      let presence: CachePresence;\n      if (getIsPresenceCacheEnabled()) {\n        presence = await cache.getValue(id);\n      }\n      if (\n        getIsPresenceCacheEnabled() &&\n        presence &&\n        getPresenceInvalidationTime() > Date.now() - (await presence).timeCached\n      ) {\n        peoplePresence[id] = JSON.parse(presence.presence);\n      } else {\n        peoplePresenceToQuery.push(id);\n      }\n    }\n  }\n\n  try {\n    if (peoplePresenceToQuery.length > 0) {\n      const presenceResult = await graph\n        .api('/communications/getPresencesByUserId')\n        .middlewareOptions(prepScopes(...scopes))\n        .post({\n          ids: peoplePresenceToQuery\n        });\n\n      for (const r of presenceResult.value) {\n        peoplePresence[r.id] = r;\n        if (getIsPresenceCacheEnabled()) {\n          cache.putValue(r.id, { presence: JSON.stringify(r) });\n        }\n      }\n    }\n\n    return peoplePresence;\n  } catch (_) {\n    try {\n      /**\n       * individual calls to getUserPresence as fallback\n       * must filter out the contacts, which will either 404 or have PresenceUnknown response\n       * caching will be handled by getUserPresence\n       */\n      const response = await Promise.all(\n        people\n          .filter(\n            person =>\n              person &&\n              person.id &&\n              !peoplePresence[person.id] &&\n              'personType' in person &&\n              (person as any).personType.subclass === 'OrganizationUser'\n          )\n          .map(person => getUserPresence(graph, person.id))\n      );\n\n      for (const r of response) {\n        peoplePresence[r.id] = r;\n      }\n      return peoplePresence;\n    } catch (_) {\n      return null;\n    }\n  }\n}\n"]}